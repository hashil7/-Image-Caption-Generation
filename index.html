<!DOCTYPE html>
<html lang=""en>
  <head>
    <meta charset="UTF-8">
    <title>Caption Generator</title>
    <style>
      body,html{
        margin:0;
        padding:0;
        height: 100%;
      }
      .centered-container{
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <div class="centered-container">
      <div>
    <input type="file" id="imageInput" accept="image/*">
    <button onClick = "uploadImage()">Generate Caption</button>
    <p id="generatedCaption"></p>
  </div>
  </div>
    <script type = "text/javascript">
      const fetchWithTimeout = (url, options, timeout = 50000) => {
          return new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
              reject(new Error('Request timed out'));
            }, timeout);

            fetch(url, options)
              .then(response => {
                clearTimeout(timer);
                resolve(response);
              })
              .catch(error => {
                clearTimeout(timer);
                reject(error);
              });
          });
        };
      async function uploadImage(){
        const input = document.getElementById('imageInput');
        if(!input.files[0]){
          alert("Please select a file to upload")
          return;
        }
        const file = input.files[0]
        const formData = new FormData();
        formData.append('file',file);

        const imageDisplay = document.getElementById('imageDisplay')||document.createElement('img');
        imageDisplay.id = 'imageDisplay';
        imageDisplay.src = URL.createObjectURL(file);
        imageDisplay.style.display = 'block'; // Ensure the element is not display:none
        imageDisplay.style.maxWidth = '500px'; // Ensure the image is not too large to be displayed
        imageDisplay.style.height = 'auto';
        document.body.appendChild(imageDisplay);
        console.log('Image element:', imageDisplay);
        console.log('Image source:', imageDisplay.src);
        try{
          const response = await fetchWithTimeout('http://127.0.0.1:8000/generate-caption/',{
            method:'POST',
            body:formData
          }
          );
          const result = await response.json()
          document.getElementById('generatedCaption').textContent = `Caption: ${result.caption}`;
        }catch(error){
          console.error('Error:',error);
          alert('Failed!')
        }
      }
    </script>

  </body>
</html>